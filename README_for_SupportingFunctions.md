# Supporting Functions

The script `Supporting_Function.R` contains helper routines used throughout the project for network analysis. This document describes the functionality, required inputs, and return values of each function.

## `plot_topN_bootstrap_edges`
Visualize the most important edges from bootstrap resampling results.

**Usage**
```r
plot_topN_bootstrap_edges(res_obj, mgm_fit = NULL, var_names = NULL,
                          top_n = 20, mode = c("abs","split","pos","neg"),
                          top_pos = NULL, top_neg = NULL,
                          main_title = "网络分析结果",
                          subtitle = "Bootstrap 95%置信区间（TopN）",
                          save_prefix = NULL, digits = 3,
                          font_family = "myfont")
```

**Arguments**
- `res_obj`: Output from `mgm::resample()` containing bootstrap samples or quantiles.
- `mgm_fit`: Optional `mgm` fit used for point estimates of edge weights.
- `var_names`: Optional character vector of variable names; defaults to names inside `mgm_fit` or `V1..Vp`.
- `top_n`: Number of edges to display when `mode` is `"abs"`, `"pos"` or `"neg"`. For `"split"`, it is divided between positive and negative edges.
- `mode`: Selection method for edges. `"abs"` selects by absolute weight, `"pos"` and `"neg"` select by sign, `"split"` divides the list into positive and negative edges.
- `top_pos`, `top_neg`: Counts of positive and negative edges when `mode = "split"`; defaults to half of `top_n` each.
- `main_title`, `subtitle`: Plot titles.
- `save_prefix`: If provided, a PDF plot is saved with this prefix.
- `digits`: Number of digits used in saved tables (currently not written).
- `font_family`: Font used in the plot.

**Returns**
Invisibly returns a list containing:
- `edge_stability`: Data frame with all pairwise edges and their confidence intervals.
- `top_edges`: Data frame of the selected top edges.
- `plot`: The `ggplot` object.

## `community_detection_and_plot`
Perform Louvain community detection on a weighted network and visualise the result.

**Usage**
```r
community_detection_and_plot(wadj, signs, var_names,
                             output_dic = TRUE,
                             return_full = FALSE,
                             save_path = NULL)
```

**Arguments**
- `wadj`: Adjacency matrix of edge weights.
- `signs`: Matrix of edge signs from the `mgm` fit.
- `var_names`: Character vector of node names.
- `output_dic`: If `TRUE`, prints a node ID to variable name lookup table.
- `return_full`: If `TRUE`, returns the graph and community objects; otherwise only the membership vector is returned.
- `save_path`: Optional path to save the network plot as a PNG file.

**Returns**
- When `return_full = TRUE`, a list with elements `graph`, `communities`, `group_vector`, and `node_map`.
- Otherwise, a numeric vector specifying the community membership of each node.

## `compute_BEI_for_network`
Calculate Bridge Expected Influence (BEI) for a single network.

**Usage**
```r
compute_BEI_for_network(wadj, signs, group_vector, var_names = NULL)
```

**Arguments**
- `wadj`: Adjacency matrix of edge weights.
- `signs`: Matrix of edge signs from the `mgm` fit.
- `group_vector`: Numeric vector assigning each node to a community.
- `var_names`: Optional character vector of node names; defaults to `V1..Vp`.

**Returns**
A data frame with columns:
- `Node`: Node name.
- `Group`: Community membership.
- `BEI`: Sum of absolute edge weights connecting the node to other communities.
The `Node` column is ordered so that nodes with larger BEI appear first in plots.

## `plot_BEI_results`
Create bar plots of BEI values, optionally across multiple conditions.

**Usage**
```r
plot_BEI_results(BEI_df, plot_title = "Bridge Expected Influence (BEI) across Conditions")
```

**Arguments**
- `BEI_df`: Data frame generated by `compute_BEI_for_network` or a combined set across conditions. Should contain columns `Node`, `Group`, `BEI`, and optionally `Condition`.
- `plot_title`: Title for the figure.

**Returns**
The `ggplot` object used to draw the bar chart (also printed to the active graphics device).

## `compute_and_plot_BEI`
Wrapper function that computes BEI for multiple condition-specific networks and plots the results.

**Usage**
```r
compute_and_plot_BEI(cond_list, group_vector, var_names,
                     condition_labels = NULL,
                     plot_title = "Bridge Expected Influence (BEI) across Conditions",
                     save_name = "BEI.pdf")
```

**Arguments**
- `cond_list`: List of `mgm` fit objects, one per condition, excluding moderator variables.
- `group_vector`: Community assignments for the shared set of nodes.
- `var_names`: Names of the nodes (no moderator).
- `condition_labels`: Optional character vector labelling each condition; defaults to `"Condition 1"`, `"Condition 2"`, etc.
- `plot_title`: Title for the BEI plot.
- `save_name`: File name for the PDF output saved in the `plot` directory.

**Returns**
Invisibly returns a list with:
- `BEI_data`: Combined BEI data across all conditions.
- `BEI_plot`: The generated `ggplot` object.

This function also saves the plot to `plot/save_name` and prints a message indicating where the file was written.

